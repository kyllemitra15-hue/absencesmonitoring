<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monthly Absence Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
      @media (max-width: 900px) {
            .comparison-card { flex: 1 1 100%; }
            .comparison-card .chart-container { height: 300px; }
        }
          @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        .dashboard {
            grid-template-columns: 1fr;
        }
        }
    body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background:linear-gradient(135deg,#667eea,#764ba2); 
            margin:0; 
            padding:20px;
            background-image:url("img/matex1.jpg");
            background-size: auto; 
    }
    .container { 
            max-width:1200px; 
            margin:auto; 
    }
    .navbar { 
            background:#4CAF50; 
            padding:12px; 
            text-align:center; 
            border-radius:6px; 
            margin-bottom:20px; 
    }
    .navbar a { 
            color:white; 
            text-decoration:none; 
            font-weight:bold; 
            margin:0 15px; 
            font-size:16px; 
    }
    .navbar a:hover { 
            text-decoration:underline; 
    }
    .card { 
            background:white; 
            border-radius:15px; 
            padding:25px; 
            box-shadow:0 10px 30px rgba(0,0,0,0.1); 
            margin-bottom:20px; 
    }
    .shift-selector { 
            display:flex; 
            gap:10px; 
            margin:15px 0; 
    }
    .shift-btn { 
            flex:1; 
            padding:10px; 
            border:2px solid #ddd; 
            border-radius:8px; 
            cursor:pointer; 
            text-align:center; 
            font-weight:500; 
    }
    .shift-btn.active { 
            background:#4CAF50; 
            color:white; 
            border-color:#4CAF50; 
    }
    .btn { 
            background:linear-gradient(45deg,#2196F3,#1976D2); 
            color:white; 
            border:none; 
            padding:10px 20px; 
            border-radius:8px; 
            cursor:pointer; 
            font-size:1rem; 
    }
    .btn:hover { 
            opacity:0.9;
     }
    .chart-container { 
            height:350px; 
            margin-top:20px; 
    }
  </style>
</head>
<body>
  <div class="container">
     <div class="navbar">            
        <a href="absence-monitoring-system.html">üè†Home</a>
        <a href="daily-report.html">üìã Daily Monitoring</a>
        <a href="monthly-report.html">üìä Monthly Report</a>
        <a href="manpower.html">üìä Manpower</a>
        <a href="index.html">üìÇ Upload File</a>
        <a href="employees.php">üìÇ All Records</a>
        <a href="manpower.php">üìÇ MP Records</a>
        </div>

    <div class="card">
      <h2>üìä Overall Monthly Absence Report</h2>
      <label>Select Month: <input type="month" id="reportMonth"></label>
      <button class="btn" onclick="loadMonthlyData()">Load Report</button>
      <button class="btn" style="margin-left:8px;" onclick="exportCSV()">Export CSV</button>
      <button class="btn" style="margin-left:8px;" onclick="exportReportPDF()">Export PDF</button>
    <div class="shift-selector">
        <div class="shift-btn active" data-shift="all">All</div>
        <div class="shift-btn" data-shift="day">Day Shift</div>
        <div class="shift-btn" data-shift="night">Night Shift</div>
    </div>
    </div>

    <div class="card" id="summary"></div>
    <div class="card chart-container"><canvas id="monthlyChart"></canvas></div>
      <div class="card chart-container"><canvas id="trendChart"></canvas></div>
      <div class="card chart-container"><canvas id="percentageChart"></canvas></div>
    </div>

    <script>
    const API_URL = "api.php";
    let selectedShift = "all";
    let monthlyChart, trendChart, percentageChart;

    document.querySelectorAll(".shift-btn").forEach(btn=>{
    btn.addEventListener("click",function(){
    document.querySelectorAll(".shift-btn").forEach(b=>b.classList.remove("active"));
    this.classList.add("active");
    selectedShift = this.dataset.shift;
    loadMonthlyData();
  });
});

  async function loadMonthlyData(){
  const month = document.getElementById("reportMonth").value;
  if(!month) return;

  const res = await fetch(`${API_URL}?month=${month}`);
  let records = await res.json();

  if(selectedShift!=="all") records = records.filter(r=>r.shift===selectedShift);
  if(!records.length){ document.getElementById("summary").innerHTML="<p>No data found</p>"; return;}

    const totalAbsent = records.reduce((s,r)=>s+r.totalAbsent,0);
    const matexTotal = records.reduce((s,r)=>s+r.matex,0);
    const avanceTotal = records.reduce((s,r)=>s+r.avance,0);
    const hrproTotal = records.reduce((s,r)=>s+r.hrpro,0);
    const leaveTotal = records.reduce((s,r)=>s+r.leave,0);

  document.getElementById("summary").innerHTML=`
      <p><b>Total Absent:</b> ${totalAbsent}</p>
      <p><b>Matex Absent:</b> ${matexTotal}</p>
      <p><b>Avance Absent:</b> ${avanceTotal}</p>
      <p><b>HRPro Absent:</b> ${hrproTotal}</p>
      <p><b>Leave/Rest Day:</b> ${leaveTotal}</p>
    `;

    monthlyChart = new Chart(document.getElementById("monthlyChart"),{
      type:"bar",
      data:{ 
      labels:["Matex","Avance","HRPro","Leave"],
      datasets:[{ 
      label:"Absences", 
      data:[matexTotal,avanceTotal,hrproTotal,leaveTotal],
      backgroundColor:["#667eea","#f093fb","#4facfe","#FFB347"] 
    }]
  }
});

    if(trendChart) trendChart.destroy();
    const ctx = document.getElementById("trendChart").getContext('2d');
    if (selectedShift === 'all') {
    const dates = [...new Set(records.map(r => r.date))].sort();
    const dayData = dates.map(d => records.filter(r => r.date === d && r.shift === 'day').reduce((s, r) => s + (parseInt(r.totalAbsent)||0), 0));
    const nightData = dates.map(d => records.filter(r => r.date === d && r.shift === 'night').reduce((s, r) => s + (parseInt(r.totalAbsent)||0), 0));
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(ctx, {
      type: 'line',
      data: { labels: dates, datasets: [
        { label: 'Day Shift', data: dayData, borderColor: '#2196F3', fill: false },
        { label: 'Night Shift', data: nightData, borderColor: '#4CAF50', fill: false }
      ] }
    });

    // percentage chart for all shifts (daily % computed against totalEmployees from first record)
    const pctCtx = document.getElementById('percentageChart').getContext('2d');
    const totalEmployees = records[0].totalEmployees || 0;
    const dailyTotals = dates.map(d => records.filter(r => r.date === d).reduce((s, r) => s + (parseInt(r.totalAbsent)||0), 0));
    const dailyPercentages = dailyTotals.map(t => totalEmployees>0 ? +(((t/totalEmployees)*100).toFixed(1)) : 0);
    if (percentageChart) percentageChart.destroy();
    percentageChart = new Chart(pctCtx, { 
      type: 'line',
      data: { labels: dates, datasets: [{ label: 'Daily Absence %', data: dailyPercentages, borderColor: '#FF5722', fill: false }] },
      options: { responsive: true, scales: { y: { ticks: { callback: v => v + '%' } } }, plugins: { tooltip: { callbacks: { label: ctx => ctx.parsed.y + '%' } } } }
    });
  } else {
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(ctx, {
      type: 'line',
      data: { labels: records.map(r => r.date), datasets: [{ label: 'Daily Absences', data: records.map(r => r.totalAbsent), borderColor: '#FF9800', fill: false }] }
    });

    // percentage chart for single shift
    const pctCtx = document.getElementById('percentageChart').getContext('2d');
    const labels = records.map(r => r.date);
    const dailyPercentages = records.map(r => r.totalEmployees>0 ? +(((r.totalAbsent||0)/r.totalEmployees)*100).toFixed(1) : 0);
    if (percentageChart) percentageChart.destroy();
    percentageChart = new Chart(pctCtx, {
      type: 'line',
      data: { labels: labels, datasets: [{ label: 'Daily Absence %', data: dailyPercentages, borderColor: '#FF5722', fill: false }] },
      options: { responsive: true, scales: { y: { ticks: { callback: v => v + '%' } } }, plugins: { tooltip: { callbacks: { label: ctx => ctx.parsed.y + '%' } } } }
    });
  }
}
</script>
<script>
async function exportCSV(){
  const month = document.getElementById('reportMonth').value;
  if(!month){ alert('Please select a month first'); return; }
  try{
    const res = await fetch(`${API_URL}?month=${month}`);
    if(!res.ok) throw new Error('Failed to fetch records');
    let records = await res.json();
    if(selectedShift && selectedShift!=='all') records = records.filter(r=>r.shift===selectedShift);
    if(!records || !records.length){ alert('No records to export for selected month/shift'); return; }
    const header = Object.keys(records[0]).filter(k=>k!=='id');
    const rows = records.map(r => header.map(h => '"' + (r[h]===undefined||r[h]===null ? '' : String(r[h]).replace(/"/g,'""')) + '"').join(','));
    const csv = [header.join(','), ...rows].join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `monthly_absences_${month}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }catch(err){ console.error(err); alert('Export CSV failed: ' + (err.message||err)); }
}

    async function exportReportPDF(){
    const { jsPDF } = window.jspdf || window.jspdf ? window.jspdf : window.jspdf = window.jspdf || window.jspdf;
    const doc = new jsPDF('p','mm','a4');
    const margin = 12; let y = 18;
    doc.setFontSize(16); doc.text('Monthly Absence Report', 105, y, { align: 'center' }); y+=8;
    const month = document.getElementById('reportMonth').value || '';
    doc.setFontSize(10); doc.text(`Month: ${month}`, margin, y); y+=6;
    // summary
    const summaryEl = document.getElementById('summary');
    if(summaryEl){ const lines = Array.from(summaryEl.querySelectorAll('p')).map(p=>p.textContent.trim()); doc.setFontSize(10); for(const line of lines){ doc.text(line, margin, y); y+=6; } y+=4; }

    async function addCanvasToPDF(id, title){ const canvas = document.getElementById(id); if(!canvas) return; const dataUrl = canvas.toDataURL('image/png',1.0); const imgProps = doc.getImageProperties(dataUrl); const pdfWidth = doc.internal.pageSize.getWidth() - margin*2; const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; if(y + pdfHeight > doc.internal.pageSize.getHeight() - margin){ doc.addPage(); y = margin; } doc.setFontSize(11); doc.text(title, margin, y); y+=6; doc.addImage(dataUrl, 'PNG', margin, y, pdfWidth, pdfHeight); y += pdfHeight + 8; }

    await addCanvasToPDF('monthlyChart','Category Totals');
    await addCanvasToPDF('trendChart','Daily Absences Trend');
    await addCanvasToPDF('percentageChart','Daily Absence Percentage');
    const now = new Date(); doc.setFontSize(9); doc.text(`Generated: ${now.toLocaleString()}`, margin, doc.internal.pageSize.getHeight()-10);
    doc.save(`monthly_report_${month||'report'}.pdf`);
}
</script>
</body>
</html>
