<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Absence Monitoring</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
      @media (max-width: 900px) {
            .comparison-card { flex: 1 1 100%; }
            .comparison-card .chart-container { height: 300px; }
        }
          @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        .dashboard {
            grid-template-columns: 1fr;
        }
        }
    body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background:linear-gradient(135deg,#667eea,#764ba2); 
            margin:0; 
            padding:20px;
            background-image:url("img/matex1.jpg");
            background-size: fill; 
    }
    .container { 
            max-width:1200px; 
            margin:auto; 
    }   
    .navbar { 
            background:#4CAF50; 
            padding:12px; 
            text-align:center; 
            border-radius:6px; 
            margin-bottom:20px; 
    }
    .navbar a { 
            color:white; 
            text-decoration:none; 
            font-weight:bold; 
            margin:0 15px; 
            font-size:16px; 
    }
    .navbar a:hover { 
            text-decoration:underline; 
    }
    .card { 
            background:white; 
            border-radius:15px; 
            padding:25px; 
            box-shadow:0 10px 30px rgba(0,0,0,0.1); 
            margin-bottom:20px; 
    }
    .card-header { 
            display:flex; 
            align-items:center; 
            margin-bottom:15px; 
            border-bottom:2px solid #f0f0f0; 
            padding-bottom:10px; 
    }
    .card-icon {  
            font-size: 1.5rem;
            margin-right: 15px;
            padding: 10px;
            width: 40px;       
            height: 40px;      
            display: flex;     
            align-items: center;
            justify-content: center;
            border-radius: 50%; 
            color: white; 
            background:#4CAF50; }
    .card-title { 
            font-size:1.3rem; 
            font-weight:600; 
    }
    .shift-selector { 
            display:flex; 
            gap:10px; 
            margin:15px 0; 
    }
    .shift-btn { 
            flex:1; 
            padding:10px; 
            border:2px solid #ddd; 
            border-radius:8px; 
            cursor:pointer; 
            text-align:center; 
            font-weight:500; 
    }
    .shift-btn.active { 
            background:#4CAF50; 
            color:white; 
            border-color:#4CAF50;  
    }
    .btn { 
            background:linear-gradient(45deg,#4CAF50,#45a049); 
            color:white; 
            border:none; 
            padding:10px 20px; 
            border-radius:8px; 
            cursor:pointer; 
            font-size:1rem; 
    }
    .btn:hover { 
            opacity:0.9; 
    }
    .chart-container { 
            height:350px; 
            margin-top:20px; 
    }
  </style>
</head>
<body>
  <div class="container">
  <div class="navbar">            
        <a href="absence-monitoring-system.html">üè†Home</a>
        <a href="daily-report.html">üìã Daily Monitoring</a>
        <a href="monthly-report.html">üìä Monthly Report</a>
        <a href="manpower.html">üìä Manpower</a>
        <a href="index.html">üìÇ Upload File</a>
        <a href="employees.php">üìÇ All Records</a>
        <a href="manpower.php">üìÇ MP Records</a>
        </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon"><i class="fas fa-plus-circle"></i></div>
        <div class="card-title">Daily Absence Input</div>
      </div>
      <form id="absenceForm">
        <label>Date: <input type="date" id="currentDate" required></label><br><br>
        <div class="shift-selector">
          <div class="shift-btn active" data-shift="day">‚òÄ Day</div>
          <div class="shift-btn" data-shift="night">üåô Night</div>
        </div>
        <label>Total Employees: <input type="number" id="totalEmployees" min="1" required></label><br>
        <label>Total Absent: <input type="number" id="totalAbsent" min="0" readonly></label><br>
        <label>Matex Absent: <input type="number" id="matexAbsent" min="0" value="0"></label><br>
        <label>Avance Absent: <input type="number" id="avanceAbsent" min="0" value="0"></label><br>
        <label>HRPro Absent: <input type="number" id="hrproAbsent" min="0" value="0"></label><br>
        <label>Leave/RD: <input type="number" id="leaveAbsent" min="0" value="0"></label><br><br>
        <button class="btn" type="submit"><i class="fas fa-save"></i> Save</button>
      </form>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-icon" style="background:#2196F3"><i class="fas fa-chart-pie"></i></div>
        <div class="card-title">Today's Statistics</div>
      </div>
      <p><b>Total Employees:</b> <span id="todayTotal">0</span></p>
      <p><b>Total Absent:</b> <span id="todayAbsent">0</span></p>
      <p><b>Present:</b> <span id="todayPresent">0</span></p>
      <p><b>Absence Rate:</b> <span id="overallPercentage">0%</span></p>
      <div class="chart-container"><canvas id="dailyChart"></canvas></div>
    </div>
  </div>

      <script>
      const API_URL = "api.php";

      // Save record
      document.getElementById("absenceForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        const date = document.getElementById("currentDate").value;
        const totalEmployees = parseInt(document.getElementById("totalEmployees").value) || 0;
        const totalAbsent = parseInt(document.getElementById("totalAbsent").value) || 0;
        const matex = parseInt(document.getElementById("matexAbsent").value) || 0;
        const avance = parseInt(document.getElementById("avanceAbsent").value) || 0;
        const hrpro = parseInt(document.getElementById("hrproAbsent").value) || 0;
        const shift = document.querySelector(".shift-btn.active").dataset.shift;
        const leave = parseInt(document.getElementById("leaveAbsent").value) || 0;
        const payload = { date, shift, totalEmployees, totalAbsent, categories:{ matex, avance, hrpro, leave } };

        const res = await fetch(API_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
        const data = await res.json();
        alert(data.message);
        loadTodayStats(date, shift);
      });

      // Auto-calculate total absent from category inputs
        function updateTotalAbsent() {
        const matex = parseInt(document.getElementById('matexAbsent').value) || 0;
        const avance = parseInt(document.getElementById('avanceAbsent').value) || 0;
        const hrpro = parseInt(document.getElementById('hrproAbsent').value) || 0;
        const leave = parseInt(document.getElementById('leaveAbsent').value) || 0;
        const total = matex + avance + hrpro + leave;
        document.getElementById('totalAbsent').value = total;

        // If total employees is set, update the small stats preview
        const totalEmployees = parseInt(document.getElementById('totalEmployees').value) || 0;
        if (totalEmployees > 0) {
          const present = totalEmployees - total;
          document.getElementById('todayAbsent').innerText = total;
          document.getElementById('todayPresent').innerText = present;
          document.getElementById('overallPercentage').innerText = ((total/totalEmployees)*100).toFixed(1) + '%';
        }
      }

      ['matexAbsent','avanceAbsent','hrproAbsent','leaveAbsent'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateTotalAbsent);
      });

      // update preview when totalEmployees changes
        const totalEmpEl = document.getElementById('totalEmployees');
        if (totalEmpEl) totalEmpEl.addEventListener('input', updateTotalAbsent);

        let chart;
        async function loadTodayStats(date, shift) {
        const res = await fetch(`${API_URL}?date=${date}`);
        const records = await res.json();
        const todayData = records.find(r => r.shift === shift);
        if (!todayData) return;

        const totalEmployees = todayData.totalEmployees;
        const totalAbsent = todayData.totalAbsent;
        const present = totalEmployees - totalAbsent;

        document.getElementById("todayTotal").innerText = totalEmployees;
        document.getElementById("todayAbsent").innerText = totalAbsent;
        document.getElementById("todayPresent").innerText = present;
        document.getElementById("overallPercentage").innerText = ((totalAbsent/totalEmployees)*100).toFixed(1)+"%";

        const ctx = document.getElementById("dailyChart").getContext("2d");
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
        type:"pie",
        data:{
          labels:["Matex","Avance","HRPro","Leave"],
          datasets:[{
            data:[todayData.matex, todayData.avance, todayData.hrpro, todayData.leave],
            backgroundColor:["#667eea","#f093fb","#4facfe","#FFB347"]
          }]
        }
      });
      }

      // Shift toggle
      document.querySelectorAll(".shift-btn").forEach(btn=>{
      btn.addEventListener("click",function(){
      document.querySelectorAll(".shift-btn").forEach(b=>b.classList.remove("active"));
      this.classList.add("active");
 });
 });
</script>
</body>
</html>
