<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Absence Monitoring</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            background: url('img/matexph.png');
            background-repeat: no-repeat;
            background-size: cover;
            
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            color:black;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        .navbar {
            background: #4CAF50;
            padding: 12px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 6px;
            }
            .navbar a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            margin: 0 15px;
            font-size: 16px;
            }
            .navbar a:hover {
            text-decoration: underline;
            }
        body { 
             font-family: 'Segoe UI', sans-serif; 
             background:#f4f6f9;
             margin:0; padding:20px;
             min-height: 100vh;
             color: #333;
             background: url('img/matexph.png');
             background-repeat: no-repeat;
             background-size: cover; 
        }

        .dashboard { 
             display:grid;
             grid-template-columns:1fr 1fr; 
             gap:20px;
        }
        .card { 
            background:white;
            border-radius:12px; 
            box-shadow:0 5px 20px rgba(0,0,0,0.1); 
            padding:20px;
        }
        .card-header { 
            display:flex; 
            align-items:center; 
            margin-bottom:15px; 
        }
        .card-icon {  
            font-size: 1.5rem;
            margin-right: 15px;
            padding: 10px;
            width: 40px;       
            height: 40px;      
            display: flex;     
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white; 
            background:#4CAF50; 
        }
        .card-title { 
            font-weight:bold; 
            font-size:1.2rem;
        }
        .form-group { 
            margin-bottom:15px;
        }
        .form-row { 
            display:flex;
            gap:15px; 
        }
        .form-group label { 
            display:block; 
            font-weight:500; 
            margin-bottom:5px; 
        }
        .form-control {
            width:100%; 
            padding:8px; 
            border:1px solid #ddd;
            border-radius:6px; 
        }
        .shift-selector { 
            display:flex; 
            gap:10px;
            margin:10px 0;
        }
        .shift-btn { 
            flex:1; 
            padding:10px; 
            border:2px solid #ddd; 
            border-radius:8px; 
            cursor:pointer; 
            text-align:center;
            font-weight:500;
        }
        .shift-btn.active { 
            background:#4CAF50;
            color:white; 
            border-color:#4CAF50; 
        }
        .btn { 
            background:#4CAF50; 
            color:white; 
            border:none; 
            padding:10px; 
            border-radius:6px; 
            cursor:pointer; 
            font-weight:bold;
            width:100%;
        }
        .btn:hover {
            background:#226e24; 
        }
        .category-stats { 
            display:flex; 
            justify-content:space-around;
            margin:15px 0; 
        }
        .category-item {
            text-align:center;
        } 
        .percentage-display { 
            font-size:1.4rem; 
            font-weight:bold; 
        }
        .stats-grid { 
            display:grid;
            grid-template-columns:repeat(2,1fr);
            gap:15px; 
            margin-top:15px; 
        }
        .stat-item { 
            background:#f9f9f9;
            padding:15px; 
            border-radius:8px;
            text-align:center; 
        } 
        .stat-value { 
            font-size:1.3rem;
            font-weight:bold; 
        }
        .charts { 
            margin-top:20px; 
        }
        .records-card {
            margin-top: 25px;
        }
         @media (max-width: 900px) {
            .comparison-card { flex: 1 1 100%; }
            .comparison-card .chart-container { height: 300px; }
        }
          @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        .dashboard {
            grid-template-columns: 1fr;
        }
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .filter-bar label {
            font-weight: 600;
            color: #444;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.1);
        }

        #recordsTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #recordsTable th {
            background: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
        }

        #recordsTable td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        #recordsTable tr:nth-child(even) {
            background: #f9f9f9;
        }

        #recordsTable .empty {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #888;
        }

        .btn-export {
            background: #ff9800;
            color: white;
            font-weight: bold;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-export:hover {
            background: #e68900;
        }
</style>
</head>
<div class="container">
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> MPDI Daily Man Power Monitoring</h1>
                <p><b>Track and analyze manpower absences across Matex, Avance, & HR Pro.</b></p>
            </div>
<body>
    <div class="navbar">            
        <a href="absence-monitoring-system.html">üè†Home</a>
        <a href="daily-report.html">üìã Daily Monitoring</a>
        <a href="monthly-report.html">üìä Monthly Report</a>
        <a href="manpower.html">üìä Manpower</a>
        <a href="index.html">üìÇ Upload File</a>
        <a href="employees.php">üìÇ All Records</a>
        <a href="manpower.php">üìÇ MP Records</a>
        </div>
        


    <div class="dashboard">
    <!-- Daily Input Card -->
    <div class="card input-card">
    <div class="card-header">
      <div class="card-icon"><i class="fas fa-plus-circle"></i></div>
      <div class="card-title">Daily Absence Input</div>
    </div>

      <form id="absenceForm" onsubmit="event.preventDefault(); saveRecord();">
      <div class="form-group">
        <label for="currentDate">Date</label>
        <input type="date" id="currentDate" class="form-control" required>
      </div>

      <div class="shift-selector">
        <div class="shift-btn active" data-shift="Day"><i class="fas fa-sun"></i> Day Shift</div>
        <div class="shift-btn" data-shift="Night"><i class="fas fa-moon"></i> Night Shift</div>
      </div>

      <!-- Agency -->
        <div class="form-group">
        <label>Manpower </label>
        <div class="form-row">
          <div class="form-group">
            <label for="matexEmployees">Matex Employees</label>
            <input type="number" id="matexEmployees" class="form-control company-emp" value="0" min="0">
          </div>
          <div class="form-group">
            <label for="matexAbsent">Matex Absent</label>
            <input type="number" id="matexAbsent" class="form-control company-absent" value="0" min="0">
          </div>
          <div class="form-group">
            <label for="matexPresent">Matex Present</label>
            <input type="number" id="matexPresent" class="form-control" readonly>
          </div>
        </div>

          <div class="form-row">
          <div class="form-group">
            <label for="avanceEmployees">Avance Employees</label>
            <input type="number" id="avanceEmployees" class="form-control company-emp" value="0" min="0">
          </div>
          <div class="form-group">
            <label for="avanceAbsent">Avance Absent</label>
            <input type="number" id="avanceAbsent" class="form-control company-absent" value="0" min="0">
          </div>
          <div class="form-group">
            <label for="avancePresent">Avance Present</label>
            <input type="number" id="avancePresent" class="form-control" readonly>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="hrproEmployees">HR Pro Employees</label>
            <input type="number" id="hrproEmployees" class="form-control company-emp" value="0" min="0">
          </div>
          <div class="form-group">
            <label for="hrproAbsent">HR Pro Absent</label>
            <input type="number" id="hrproAbsent" class="form-control company-absent" value="0" min="0">
          </div>
          <div class="form-group">
            <label for="hrproPresent">HR Pro Present</label>
            <input type="number" id="hrproPresent" class="form-control" readonly>
          </div>
        </div>
      </div>

      <!-- Totals -->
      <div class="form-row">
        <div class="form-group">
          <label for="totalEmployees">Total Employees</label>
          <input type="number" id="totalEmployees" class="form-control" readonly>
        </div>
        <div class="form-group">
          <label for="totalAbsent">Total Absent</label>
          <input type="number" id="totalAbsent" class="form-control" readonly>
        </div>
        <div class="form-group">
          <label for="totalPresent">Total Present</label>
          <input type="number" id="totalPresent" class="form-control" readonly>
        </div>
      </div>

      <button type="submit" class="btn"><i class="fas fa-save"></i> Save Absence Data</button>
    </form>
  </div>

  <!-- Statistics Card -->
  <div class="card stats-card">
    <div class="card-header">
      <div class="card-icon" style="background:#2196F3"><i class="fas fa-chart-pie"></i></div>
      <div class="card-title">Today's Statistics</div>
    </div>

    <div id="todayStats">
      <div class="category-stats">
        <div class="category-item"><div class="percentage-display" id="matexPercentage">0%</div><div class="category-label">Matex</div></div>
        <div class="category-item"><div class="percentage-display" id="avancePercentage">0%</div><div class="category-label">Avance</div></div>
        <div class="category-item"><div class="percentage-display" id="hrproPercentage">0%</div><div class="category-label">HR Pro</div></div>
      </div>

      <div class="stats-grid">
        <div class="stat-item"><div class="stat-value" id="todayTotal">0</div><div class="stat-label">Total Employees</div></div>
        <div class="stat-item"><div class="stat-value" id="todayAbsent">0</div><div class="stat-label">Total Absent</div></div>
        <div class="stat-item"><div class="stat-value" id="todayPresent">0</div><div class="stat-label">Present</div></div>
        <div class="stat-item"><div class="stat-value" id="overallPercentage">0%</div><div class="stat-label">Absence Rate</div></div>
      </div>
    </div>

    <div class="charts">
      <h3>Manpower Overview</h3>
      <canvas id="barChart" height="120"></canvas>

      <h3 style="margin-top:20px;">Absent Trend</h3>
      <canvas id="lineChart" height="120"></canvas>
    </div>
    
  </div>
</div>
<div class="card records-card">
  <div class="card-header flex items-center justify-between">
    <div class="flex items-center gap-2">
      <div class="card-icon"><i class="fas fa-table"></i></div>
      <div class="card-title">üìÖ Monthly Records</div>
    </div>
    <button onclick="exportMonthlyCSV()" class="btn btn-export">
      ‚¨á Export CSV
    </button>
  </div>

  <!-- Filter Section -->
  <div class="filter-bar">
    <label for="recordMonth">Select Month:</label>
    <input type="month" id="recordMonth" class="form-control">
    <button onclick="loadMonthlyRecords()" class="btn btn-primary">
      <i class="fas fa-search"></i> View
    </button>
  </div>

  <!-- Records Table -->
  <div class="table-wrapper">
    <table id="recordsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Shift</th>
          <th>Matex <br><small>(Emp / Absent)</small></th>
          <th>Avance <br><small>(Emp / Absent)</small></th>
          <th>HR Pro <br><small>(Emp / Absent)</small></th>
          <th>Total <br><small>(E / A / P)</small></th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6" class="empty">Select a month to view records</td></tr>
      </tbody>
    </table>
  </div>
</div>



<script>
let barChart, lineChart;
let selectedShift = "Day";

// set date default today
document.getElementById("currentDate").value = new Date().toISOString().split("T")[0];

// shift buttons
document.querySelectorAll(".shift-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".shift-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedShift = btn.dataset.shift;
  });
});

//SAVE TO DATABASE
async function saveRecord() {
    const data = {
        date: document.getElementById("currentDate").value,
        shift: selectedShift,
        matexEmployees: parseInt(document.getElementById("matexEmployees").value) || 0,
        matexAbsent: parseInt(document.getElementById("matexAbsent").value) || 0,
        avanceEmployees: parseInt(document.getElementById("avanceEmployees").value) || 0,
        avanceAbsent: parseInt(document.getElementById("avanceAbsent").value) || 0,
        hrproEmployees: parseInt(document.getElementById("hrproEmployees").value) || 0,
        hrproAbsent: parseInt(document.getElementById("hrproAbsent").value) || 0,
        totalEmployees: parseInt(document.getElementById("totalEmployees").value) || 0,
        totalAbsent: parseInt(document.getElementById("totalAbsent").value) || 0,
        totalPresent: parseInt(document.getElementById("totalPresent").value) || 0,
    };

    try {
        const res = await fetch("manpower_api.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await res.json();
        alert(result.message);
    } catch (err) {
        console.error("Save failed:", err);
        alert(" Failed to save. Check console / API.");
    }
}

//UPDATE AGENCY DATA & CHART
function updateAgencyData() {
  const agencies = ["matex","avance","hrpro"];
  let totalEmployees=0, totalAbsent=0;
  let empData=[],absentData=[],presentData=[];
  agencies.forEach(agency=>{
    const emp = parseInt(document.getElementById(agency+"Employees").value)||0;
    let abs = parseInt(document.getElementById(agency+"Absent").value)||0;
    if(abs>emp){abs=emp; document.getElementById(agency+"Absent").value=emp;}
    const present = emp-abs;
    document.getElementById(agency+"Present").value=present;
    empData.push(emp); absentData.push(abs); presentData.push(present);
    totalEmployees+=emp; totalAbsent+=abs;
  });
    document.getElementById("totalEmployees").value=totalEmployees;
    document.getElementById("totalAbsent").value=totalAbsent;
    document.getElementById("totalPresent").value=totalEmployees-totalAbsent;
    document.getElementById("todayTotal").innerText=totalEmployees;
    document.getElementById("todayAbsent").innerText=totalAbsent;
    document.getElementById("todayPresent").innerText=totalEmployees-totalAbsent;
    document.getElementById("overallPercentage").innerText=((totalAbsent/Math.max(totalEmployees,1))*100).toFixed(1)+"%";
    document.getElementById("matexPercentage").innerText=((absentData[0]/Math.max(empData[0],1))*100).toFixed(1)+"%";
    document.getElementById("avancePercentage").innerText=((absentData[1]/Math.max(empData[1],1))*100).toFixed(1)+"%";
    document.getElementById("hrproPercentage").innerText=((absentData[2]/Math.max(empData[2],1))*100).toFixed(1)+"%";
  // bar chart
  if(!barChart){
    barChart=new Chart(document.getElementById("barChart"),{
          type:"bar",
          data:{
          labels:["Matex","Avance","HR Pro"],
          datasets:[
          {label:"Employees",data:empData,backgroundColor:"rgba(54,162,235,0.7)"},
          {label:"Absent",data:absentData,backgroundColor:"rgba(255,99,132,0.7)"},
          {label:"Present",data:presentData,backgroundColor:"rgba(75,192,192,0.7)"}
        ]
      },
      options:{responsive:true,plugins:{legend:{position:"top"}}}
    });
  } else {
    barChart.data.datasets[0].data=empData;
    barChart.data.datasets[1].data=absentData;
    barChart.data.datasets[2].data=presentData;
    barChart.update();
  }
}
//LINE CHART (ABSENT % TREND)
async function loadTrend() {
  try {
    const res = await fetch("manpower_api.php?trend=1");
    let records = await res.json();

    // put oldest first
    records = records.reverse();
    
    const labels = records.map(r => r.date + " (" + r.shift + ")");
    const matexPct = records.map(r => r.matexPct);
    const avancePct = records.map(r => r.avancePct);
    const hrproPct = records.map(r => r.hrproPct);
    
    if (!lineChart) {
      lineChart = new Chart(document.getElementById("lineChart"), {
              type: "line",
              data: {
              labels: labels,
              datasets: [
            { label: "Matex %", data: matexPct, borderColor: "rgba(34,177,76,1)", fill: false },
            { label: "Avance %", data: avancePct, borderColor: "rgba(54,162,235,1)", fill: false },
            { label: "HR Pro %", data: hrproPct, borderColor: "rgba(75,192,192,1)", fill: false }
          ]
        },
            options: {
            responsive: true,
            plugins: {
            legend: { position: "top" }
          },
            scales: {
            y: {
              title: { display: true, text: "Absent %" },
              beginAtZero: true,
              max: 10
            }
          }
        }
      });
    } 
    else {
      lineChart.data.labels = labels;
      lineChart.data.datasets[0].data = matexPct;
      lineChart.data.datasets[1].data = avancePct;
      lineChart.data.datasets[2].data = hrproPct;
      lineChart.update();
    }
  } catch (err) {
    console.error("Trend load failed:", err);
  }
}
// auto update when typing
document.querySelectorAll(".company-emp,.company-absent").forEach(inp=>{
  inp.addEventListener("input",updateAgencyData);
});
// init
updateAgencyData();
loadTrend();
//LOAD MONTHLY RECORDS 
async function loadMonthlyRecords() {
  const month = document.getElementById("recordMonth").value;
  if (!month) return alert("Please select a month");
  try {
    const res = await fetch(`manpower_api.php?month=${month}`);
    const records = await res.json();

    const tbody = document.querySelector("#recordsTable tbody");
    tbody.innerHTML = "";
    if (records.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6">No records found for ${month}</td></tr>`;
      return;
    }
    records.forEach(r => {
      const row = `
        <tr>
          <td>${r.date}</td>
          <td>${r.shift}</td>
          <td>${r.matexEmployees} / ${r.matexAbsent}</td>
          <td>${r.avanceEmployees} / ${r.avanceAbsent}</td>
          <td>${r.hrproEmployees} / ${r.hrproAbsent}</td>
          <td>${r.totalEmployees} / ${r.totalAbsent} / ${r.totalPresent}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  } catch (err) {
    console.error("Failed to load monthly records:", err);
  }
}
</script>
</body>
</html>